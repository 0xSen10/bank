<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Bank å‰ç«¯ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .connect-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .wallet-info {
            font-size: 0.9em;
            color: #666;
        }

        .balances-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .balance-label {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .balance-amount {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .balance-unit {
            font-size: 1em;
            opacity: 0.8;
        }

        .actions-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .action-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .action-card h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .deposit-btn {
            background: linear-gradient(135deg, #4cd964 0%, #5ac8fa 100%);
            color: white;
        }

        .withdraw-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            color: white;
        }

        .signature-btn {
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            color: white;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .deposit-options {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .deposit-options h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
        }

        .option-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .option-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option-description {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1em;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .token-info {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .balances-section,
            .actions-section {
                grid-template-columns: 1fr;
            }
            
            .option-buttons {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦ Token Bank</h1>
        <div class="subtitle">æ”¯æŒç¦»çº¿ç­¾åæˆæƒçš„å»ä¸­å¿ƒåŒ–å­˜æ¬¾å¹³å°</div>
        
        <div class="token-info" id="tokenInfo">
            æ­£åœ¨åŠ è½½ä»£å¸ä¿¡æ¯...
        </div>
        
        <div class="wallet-section">
            <button id="connectButton" class="connect-btn">ğŸ”— è¿æ¥é’±åŒ…</button>
            <div class="wallet-info">
                è¿æ¥åœ°å€: <span id="userAddress">æœªè¿æ¥</span>
            </div>
        </div>
        
        <div class="balances-section">
            <div class="balance-card">
                <div class="balance-label">ğŸ’° ä»£å¸ä½™é¢</div>
                <div class="balance-amount" id="tokenBalance">0</div>
                <div class="balance-unit">SERC20</div>
            </div>
            
            <div class="balance-card">
                <div class="balance-label">ğŸ¦ å­˜æ¬¾ä½™é¢</div>
                <div class="balance-amount" id="bankBalance">0</div>
                <div class="balance-unit">åœ¨ Token Bank ä¸­</div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šå­˜æ¬¾æ–¹å¼é€‰æ‹© -->
        <div class="deposit-options">
            <h3>ğŸ“¥ é€‰æ‹©å­˜æ¬¾æ–¹å¼</h3>
            <div class="option-buttons">
                <button id="traditionalDepositBtn" class="option-btn active">ä¼ ç»Ÿå­˜æ¬¾</button>
                <button id="signatureDepositBtn" class="option-btn">ç­¾åå­˜æ¬¾ (Permit)</button>
            </div>
            <div class="option-description" id="optionDescription">
                ä¼ ç»Ÿå­˜æ¬¾æ–¹å¼ï¼šå…ˆæˆæƒå†å­˜æ¬¾ï¼Œéœ€è¦ä¸¤ç¬”äº¤æ˜“
            </div>
        </div>
        
        <div class="actions-section">
            <div class="action-card">
                <h3 id="depositTitle">ğŸ“¥ ä¼ ç»Ÿå­˜æ¬¾</h3>
                <div class="input-group">
                    <input type="number" id="depositAmount" placeholder="è¾“å…¥å­˜æ¬¾é‡‘é¢" step="0.001" min="0">
                </div>
                <button id="depositButton" class="action-btn deposit-btn">ç¡®è®¤å­˜æ¬¾</button>
                <div id="depositDescription" style="font-size: 0.9em; color: #666; text-align: center;">
                    éœ€è¦å…ˆæˆæƒå†å­˜æ¬¾ï¼ˆ2ç¬”äº¤æ˜“ï¼‰
                </div>
            </div>
            
            <div class="action-card">
                <h3>ğŸ“¤ å–æ¬¾</h3>
                <div class="input-group">
                    <input type="number" id="withdrawAmount" placeholder="è¾“å…¥å–æ¬¾é‡‘é¢" step="0.001" min="0">
                </div>
                <button id="withdrawButton" class="action-btn withdraw-btn">ç¡®è®¤å–æ¬¾</button>
            </div>
        </div>
        
        <div id="status" class="status"></div>
    </div>

    <!-- å…ˆå¯¼å…¥ tokenBankUI.js -->
   <script type="module">
    console.log('1. å¼€å§‹æ‰§è¡Œè„šæœ¬');

    let TokenBankUI;
    window.tokenBankUIInstance = null;
    let currentDepositMethod = 'traditional'; // é»˜è®¤ä¼ ç»Ÿå­˜æ¬¾

    // åŠ¨æ€å¯¼å…¥ tokenBankUI.js
    import('./tokenBankUI.js')
        .then(module => {
            console.log('2. TokenBankUI æ¨¡å—åŠ è½½æˆåŠŸ');
            TokenBankUI = module.TokenBankUI;
            window.TokenBankUI = TokenBankUI;
            initializeApp();
        })
        .catch(error => {
            console.error('3. åŠ è½½ tokenBankUI.js å¤±è´¥:', error);
        });

    function initializeApp() {
        console.log('4. åˆå§‹åŒ–åº”ç”¨');
        
        // è®¾ç½®å­˜æ¬¾æ–¹å¼åˆ‡æ¢
        setupDepositOptions();
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç‚¹å‡»
        document.addEventListener('click', function(event) {
            if (event.target.id === 'connectButton' || event.target.closest('#connectButton')) {
                console.log('5. è¿æ¥é’±åŒ…æŒ‰é’®è¢«ç‚¹å‡»');
                handleConnectWallet();
            }
            
            if (event.target.id === 'depositButton' || event.target.closest('#depositButton')) {
                console.log('6. å­˜æ¬¾æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰æ–¹å¼:', currentDepositMethod);
                handleDeposit();
            }
            
            if (event.target.id === 'withdrawButton' || event.target.closest('#withdrawButton')) {
                console.log('7. å–æ¬¾æŒ‰é’®è¢«ç‚¹å‡»');
                handleWithdraw();
            }
        });

        console.log('8. åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        autoConnect();
    }

    function setupDepositOptions() {
        console.log('9. è®¾ç½®å­˜æ¬¾æ–¹å¼é€‰é¡¹');
        
        const traditionalBtn = document.getElementById('traditionalDepositBtn');
        const signatureBtn = document.getElementById('signatureDepositBtn');
        const depositTitle = document.getElementById('depositTitle');
        const depositButton = document.getElementById('depositButton');
        const depositDescription = document.getElementById('depositDescription');
        const optionDescription = document.getElementById('optionDescription');

        console.log('10. å­˜æ¬¾æ–¹å¼æŒ‰é’®:', {
            traditionalBtn: !!traditionalBtn,
            signatureBtn: !!signatureBtn,
            depositTitle: !!depositTitle,
            depositButton: !!depositButton
        });

        if (traditionalBtn && signatureBtn) {
            // ä¼ ç»Ÿå­˜æ¬¾æŒ‰é’®
            traditionalBtn.addEventListener('click', function() {
                console.log('11. ç‚¹å‡»ä¼ ç»Ÿå­˜æ¬¾');
                currentDepositMethod = 'traditional';
                traditionalBtn.classList.add('active');
                signatureBtn.classList.remove('active');
                
                if (depositTitle) depositTitle.textContent = 'ğŸ“¥ ä¼ ç»Ÿå­˜æ¬¾';
                if (depositButton) depositButton.textContent = 'ç¡®è®¤å­˜æ¬¾';
                if (depositDescription) depositDescription.textContent = 'éœ€è¦å…ˆæˆæƒå†å­˜æ¬¾ï¼ˆ2ç¬”äº¤æ˜“ï¼‰';
                if (optionDescription) optionDescription.textContent = 'ä¼ ç»Ÿå­˜æ¬¾æ–¹å¼ï¼šå…ˆæˆæƒå†å­˜æ¬¾ï¼Œéœ€è¦ä¸¤ç¬”äº¤æ˜“';
            });

            // ç­¾åå­˜æ¬¾æŒ‰é’®
            signatureBtn.addEventListener('click', function() {
                console.log('12. ç‚¹å‡»ç­¾åå­˜æ¬¾');
                currentDepositMethod = 'signature';
                signatureBtn.classList.add('active');
                traditionalBtn.classList.remove('active');
                
                if (depositTitle) depositTitle.textContent = 'ğŸ“ ç­¾åå­˜æ¬¾';
                if (depositButton) depositButton.textContent = 'ç­¾åå¹¶å­˜æ¬¾';
                if (depositDescription) depositDescription.textContent = 'ä½¿ç”¨ç¦»çº¿ç­¾åï¼Œåªéœ€ä¸€ç¬”äº¤æ˜“';
                if (optionDescription) optionDescription.textContent = 'ç­¾åå­˜æ¬¾æ–¹å¼ï¼šä½¿ç”¨ EIP-712 ç¦»çº¿ç­¾åï¼Œåªéœ€ä¸€ç¬”äº¤æ˜“å®Œæˆæˆæƒå’Œå­˜æ¬¾';
            });

            console.log('13. å­˜æ¬¾æ–¹å¼äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
        } else {
            console.error('14. é”™è¯¯: æ‰¾ä¸åˆ°å­˜æ¬¾æ–¹å¼æŒ‰é’®');
        }
    }

    async function handleDeposit() {
        console.log('15. å¤„ç†å­˜æ¬¾ï¼Œæ–¹å¼:', currentDepositMethod);
        
        const amountInput = document.getElementById('depositAmount');
        const amount = amountInput ? amountInput.value : '';
        
        console.log('16. å­˜æ¬¾é‡‘é¢:', amount);
        
        if (!amount || parseFloat(amount) <= 0) {
            showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢', 'error');
            return;
        }

        if (!window.tokenBankUIInstance) {
            showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            return;
        }

        try {
            if (currentDepositMethod === 'traditional') {
                console.log('17. æ‰§è¡Œä¼ ç»Ÿå­˜æ¬¾');
                await window.tokenBankUIInstance.depositWithApproval(amount);
                showStatus('å­˜æ¬¾æˆåŠŸï¼', 'success');
            } else {
                console.log('18. æ‰§è¡Œç­¾åå­˜æ¬¾');
                await window.tokenBankUIInstance.depositWithSignature(amount);
                showStatus('ç­¾åå­˜æ¬¾æˆåŠŸï¼', 'success');
            }
            
            await updateBalances();
            if (amountInput) amountInput.value = '';
            
        } catch (error) {
            console.error('19. å­˜æ¬¾å¤±è´¥:', error);
            showStatus(`å­˜æ¬¾å¤±è´¥: ${error.message}`, 'error');
        }
    }

    async function handleWithdraw() {
        console.log('20. å¤„ç†å–æ¬¾');
        
        const amountInput = document.getElementById('withdrawAmount');
        const amount = amountInput ? amountInput.value : '';
        
        if (!amount || parseFloat(amount) <= 0) {
            showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„å–æ¬¾é‡‘é¢', 'error');
            return;
        }

        if (!window.tokenBankUIInstance) {
            showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            return;
        }

        try {
            await window.tokenBankUIInstance.withdraw(amount);
            showStatus('å–æ¬¾æˆåŠŸï¼', 'success');
            
            await updateBalances();
            if (amountInput) amountInput.value = '';
            
        } catch (error) {
            console.error('å–æ¬¾å¤±è´¥:', error);
            showStatus(`å–æ¬¾å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼ˆhandleConnectWallet, updateBalances, autoConnect, showStatus ç­‰ï¼‰
    async function handleConnectWallet() {
        console.log('21. å¤„ç†é’±åŒ…è¿æ¥');
        
        try {
            if (typeof window.ethereum !== 'undefined') {
                console.log('22. æ£€æµ‹åˆ° MetaMask');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('23. è·å–åˆ°è´¦æˆ·:', accounts);
                
                if (accounts.length > 0 && TokenBankUI) {
                    window.tokenBankUIInstance = new TokenBankUI(window.ethereum);
                    console.log('24. TokenBankUI å®ä¾‹åˆ›å»ºå®Œæˆ');
                    
                    const userAddress = accounts[0];
                    document.getElementById('userAddress').textContent = 
                        `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                    
                    showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                    console.log('25. é’±åŒ…è¿æ¥æˆåŠŸ');
                    
                    await updateBalances();
                }
            } else {
                showStatus('è¯·å®‰è£… MetaMask', 'error');
            }
        } catch (error) {
            console.error('26. è¿æ¥å¤±è´¥:', error);
            showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        }
    }

    async function updateBalances() {
        console.log('27. å¼€å§‹æ›´æ–°ä½™é¢');
        // ä½™é¢æ›´æ–°é€»è¾‘...
    }

    async function autoConnect() {
        console.log('28. å°è¯•è‡ªåŠ¨è¿æ¥');
        // è‡ªåŠ¨è¿æ¥é€»è¾‘...
    }

    function showStatus(message, type = 'info') {
        const statusElement = document.getElementById('status');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
        }
    }

    console.log('29. è„šæœ¬åŠ è½½å®Œæˆ');
</script>
</body>
</html>